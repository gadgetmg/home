# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

run: when_changed

env:
  # renovate: datasource=github-releases depName=siderolabs/talos
  TALOS_VERSION: v1.11.3
  # renovate: datasource=github-releases depName=kubernetes/kubernetes
  KUBERNETES_VERSION: v1.34.1

vars:
  BUILD_ARGS: --load-restrictor LoadRestrictionsNone --enable-helm --enable-alpha-plugins
  ENV: test

includes:
  production:
    taskfile: clusters/production/Taskfile.yaml
    dir: clusters/production
  test:
    taskfile: clusters/test/Taskfile.yaml
    dir: clusters/test
  tests: tests/tasks.yaml
  apps: apps/tasks.yaml

tasks:
  kubeconform:
    cmd: kubeconform -output pretty -kubernetes-version {{.KUBERNETES_VERSION | trimPrefix "v"}} -schema-location default -schema-location 'schemas/{{`{{.Group}}`}}/{{`{{.ResourceKind}}`}}_{{`{{.ResourceAPIVersion}}`}}.json' -skip EnvoyProxy,Backend,SecurityPolicy manifests/
    sources:
    - manifests/**/*

  renovate:
    env:
      LOG_LEVEL: DEBUG
      GITHUB_COM_TOKEN: {sh: gh auth token}
    cmds:
    - renovate --platform=local

  build:
    internal: true
    label: build {{.APP}} {{.ENV}}
    requires:
      vars: [APP, ENV]
    cmds:
    - rm -rf manifests/{{.ENV}}/{{.APP}}
    - mkdir -p crds/{{.ENV}}
    - mkdir -p manifests/{{.ENV}}/{{.APP}}
    - kustomize build {{.BUILD_ARGS}} apps/{{.APP}}/{{.ENV}} -o manifests/{{.ENV}}/{{.APP}}
    - find manifests/{{.ENV}}/{{.APP}} -name '*:*' -exec sh -c 'f="{}"; mv -- "$f" "${f//:/-}"' \;
    - find manifests/{{.ENV}}/{{.APP}} -name 'apiextensions.k8s.io_v1_customresourcedefinition_*' -exec mv -f {} crds/{{.ENV}} \;
    sources:
    - apps/{{.APP}}/**/*
    - shared/**/*
    generates:
    - manifests/{{.ENV}}/{{.APP}}/**/*

  hydrate:
    vars:
      TARGETS: {sh: 'find apps -name base -prune -o -type d -exec test -e {}/kustomization.yaml \; -print -prune'}
    cmds:
    - for: {var: TARGETS, as: DIR}
      vars: {APP: '{{dir .DIR | base}}', ENV: '{{base .DIR}}'}
      task: build
    - git add --intent-to-add manifests

  crds:
    cmd: kubectl apply --server-side -f crds/{{.ENV}}
    status:
    - kubectl diff -f crds/{{.ENV}}

  login:
  - kubectl config set-context --current --namespace argocd
  - argocd login --core

  deploy:
    label: deploy {{.APP}} {{.ENV}}
    deps:
    - bootstrap
    - login
    - {task: build, vars: {APP: '{{.APP}}', ENV: '{{.ENV}}'}}
    requires:
      vars: [APP, ENV]
    cmds:
    - argocd app create {{.APP}} --dest-name in-cluster --repo /nonexistent --path / --validate=false --upsert
    # Handle intermittent disconnects from the argocd-server service with a loop
    - for i in {1..3}; do argocd app sync {{.APP}} --local manifests/{{.ENV}}/{{.APP}} --server-side --apply-out-of-sync-only --prune --retry-limit 3 --output tree && break; sleep 1; done

  bootstrap:
    deps:
    - {task: build, vars: {APP: 'cilium', ENV: '{{.ENV}}'}}
    - {task: build, vars: {APP: 'argocd', ENV: '{{.ENV}}'}}
    status:
    - kubectl get namespace argocd
    sources:
    - manifests/{{.ENV}}/cilium/*.yaml
    - manifests/{{.ENV}}/argocd/rbac.authorization.k8s.io_v1_*.yaml
    - manifests/{{.ENV}}/argocd/argocd_v1_*.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_deployment_argocd-applicationset-controller.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_deployment_argocd-notifications-controller.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_deployment_argocd-redis.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_deployment_argocd-repo-server.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_deployment_argocd-server.yaml
    - manifests/{{.ENV}}/argocd/argocd_apps_v1_statefulset_argocd-application-controller.yaml
    - manifests/{{.ENV}}/argocd/argocd_batch_v1_job_argocd-redis-secret-init.yaml
    - manifests/{{.ENV}}/argocd/argocd_rbac.authorization.k8s.io_v1_*.yaml
    - manifests/{{.ENV}}/argocd/apiextensions.k8s.io_v1_customresourcedefinition_*.yaml
    cmds:
    - task: crds
    - kubectl apply --server-side -f manifests/{{.ENV}}/cilium/v1_namespace_cilium-secrets.yaml
    - kubectl apply --server-side -f manifests/{{.ENV}}/argocd/v1_namespace_argocd.yaml
    - for: sources
      cmd: kubectl apply --server-side --force-conflicts -f {{.ITEM}}
    - kubectl wait --namespace argocd --for=condition=available --timeout=5m deployment/argocd-applicationset-controller
    - kubectl wait --namespace argocd --for=condition=available --timeout=5m deployment/argocd-notifications-controller
    - kubectl wait --namespace argocd --for=condition=available --timeout=5m deployment/argocd-redis
    - kubectl wait --namespace argocd --for=condition=available --timeout=5m deployment/argocd-repo-server
    - kubectl wait --namespace argocd --for=condition=available --timeout=5m deployment/argocd-server
    - kubectl rollout status --namespace argocd --watch --timeout=5m statefulset/argocd-application-controller
