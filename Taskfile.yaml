# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

run: when_changed

env:
  # renovate: datasource=github-releases depName=siderolabs/talos
  TALOS_VERSION: v1.11.5
  # renovate: datasource=github-releases depName=kubernetes/kubernetes
  KUBERNETES_VERSION: v1.34.2

vars:
  ENV: test
  BUILD_ARGS: --load-restrictor LoadRestrictionsNone --enable-helm --enable-alpha-plugins
  KUBECTL_CTX: admin@{{.ENV}}
  KUBECTL: kubectl --context {{.KUBECTL_CTX}}
  ARGOCD_NAMESPACE: argocd
  ARGOCD: argocd --kube-context {{.KUBECTL_CTX}} --port-forward-namespace {{.ARGOCD_NAMESPACE}} --loglevel error

includes:
  production:
    taskfile: clusters/production/Taskfile.yaml
    dir: clusters/production
  test:
    taskfile: clusters/test/Taskfile.yaml
    dir: clusters/test
  tests: tests/tasks.yaml
  apps:
    taskfile: apps/tasks.yaml
    internal: true

tasks:
  kubeconform:
    desc: Validate schema of all manifests under manifests/
    cmd: |
      kubeconform -output pretty \
        -kubernetes-version {{.KUBERNETES_VERSION | trimPrefix "v"}} \
        -schema-location default \
        -schema-location 'schemas/{{`{{.Group}}`}}/{{`{{.ResourceKind}}`}}_{{`{{.ResourceAPIVersion}}`}}.json' \
        -skip EnvoyProxy,Backend,SecurityPolicy \
        manifests/
    sources:
    - manifests/**/*

  renovate:
    desc: Local run of Mend Renovate
    env:
      LOG_LEVEL: DEBUG
      GITHUB_COM_TOKEN: {sh: gh auth token}
    cmds:
    - renovate --platform=local

  build:
    desc: Build sources for app (APP) in environment (ENV)
    label: build {{.APP}} {{.ENV}}
    requires:
      vars: [APP, ENV]
    vars:
      APP_MANIFEST_DIR: manifests/{{.ENV}}/{{.APP}}
    cmds:
    - rm -rf {{.APP_MANIFEST_DIR}}
    - mkdir -p crds/{{.ENV}}
    - mkdir -p {{.APP_MANIFEST_DIR}}
    - kustomize build {{.BUILD_ARGS}} apps/{{.APP}}/{{.ENV}} -o {{.APP_MANIFEST_DIR}}
    - find {{.APP_MANIFEST_DIR}} -name '*:*' -exec sh -c 'f="{}"; mv -- "$f" "${f//:/-}"' \;
    - find {{.APP_MANIFEST_DIR}} -name 'apiextensions.k8s.io_v1_customresourcedefinition_*' -exec mv -f {} crds/{{.ENV}} \;
    sources:
    - apps/{{.APP}}/**/*
    - shared/**/*
    generates:
    - '{{.APP_MANIFEST_DIR}}/**/*'

  hydrate:
    desc: Hydrate all apps and environments to /manifests
    vars:
      TARGETS: {sh: 'find apps -name base -prune -o -type d -exec test -e {}/kustomization.yaml \; -print -prune'}
    cmds:
    - for: {var: TARGETS, as: DIR}
      vars: {APP: '{{dir .DIR | base}}', ENV: '{{base .DIR}}'}
      task: build
    - git add --intent-to-add manifests

  crds:
    desc: Apply CRDs to environment (ENV)
    cmd: '{{.KUBECTL}} apply --server-side -f crds/{{.ENV}}'
    requires:
      vars: [ENV]
    status:
    - '{{.KUBECTL}} diff -f crds/{{.ENV}}'

  login:
    desc: Login to Argo CD CLI in environment (ENV)
    silent: true
    vars:
      USERNAME: admin
      PASSWORD:
        sh: '{{.KUBECTL}} --namespace {{.ARGOCD_NAMESPACE}} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d'
    cmd: '{{.ARGOCD}} login --port-forward --plaintext --username {{.USERNAME}} --password {{.PASSWORD}}'

  create:
    internal: true
    status:
    - '{{.ARGOCD}} app get {{.APP}}'
    requires:
      vars: [APP]
    cmd: '{{.ARGOCD}} app create {{.APP}} --dest-name in-cluster --repo /nonexistent --path / --validate=false'

  deploy:
    desc: Deploy local rendered manifests of app (APP) to environment (ENV)
    label: deploy {{.APP}} {{.ENV}}
    deps:
    - {task: build, vars: {APP: '{{.APP}}', ENV: '{{.ENV}}'}}
    requires:
      vars: [APP, ENV]
    vars:
      APP_MANIFEST_DIR: manifests/{{.ENV}}/{{.APP}}
    cmds:
    - task: login
    - {task: create, vars: {APP: '{{.APP}}'}}
    - '{{.ARGOCD}} app set {{.APP}} --sync-policy manual --validate=false'
    - cmd: '{{.ARGOCD}} app terminate-op {{.APP}} 2> /dev/null'
      ignore_error: true
    - '{{.ARGOCD}} app sync {{.APP}} --local {{.APP_MANIFEST_DIR}} --server-side --apply-out-of-sync-only --prune --retry-limit 2 --output tree'

  bootstrap:
    desc: Bootstrap environment (ENV) with CRDs, Cilium, and Argo CD
    label: bootstrap {{.ENV}}
    deps:
    - {task: build, vars: {APP: 'cilium', ENV: '{{.ENV}}'}}
    - {task: build, vars: {APP: 'argocd', ENV: '{{.ENV}}'}}
    status:
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=1s deployment/argocd-server'
    sources:
    - manifests/{{.ENV}}/cilium/*.yaml
    - manifests/{{.ENV}}/argocd/rbac.authorization.k8s.io_v1_*.yaml
    - manifests/{{.ENV}}/argocd/v1_*.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-applicationset-controller.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-notifications-controller.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-redis.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-repo-server.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-server.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_statefulset_argocd-application-controller.yaml
    - manifests/{{.ENV}}/argocd/batch_v1_job_argocd-redis-secret-init.yaml
    - manifests/{{.ENV}}/argocd/rbac.authorization.k8s.io_v1_*.yaml
    cmds:
    - task: crds
    - '{{.KUBECTL}} apply --server-side -f manifests/{{.ENV}}/cilium/v1_namespace_cilium-secrets.yaml'
    - '{{.KUBECTL}} apply --server-side -f manifests/{{.ENV}}/argocd/v1_namespace_argocd.yaml'
    - for: sources
      cmd: '{{.KUBECTL}} apply --server-side --force-conflicts -f {{.ITEM}}'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-applicationset-controller'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-notifications-controller'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-redis'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-repo-server'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-server'
    - '{{.KUBECTL}} rollout status --namespace {{.ARGOCD_NAMESPACE}} --watch --timeout=5m statefulset/argocd-application-controller'

  kubeseal:validate:
    desc: Validate all sealed secrets in environment (ENV) can be decrypted with kubeseal
    label: kubeseal:validate {{.ENV}}
    requires:
      vars: [ENV]
    cmd: find manifests/{{.ENV}} -name '*bitnami.com_v1alpha1_sealedsecret*.yaml' | xargs -I {} sh -c 'kubeseal --context {{.KUBECTL_CTX}} --validate < "{}"'

  kubeseal:re-encrypt:
    desc: Re-encrypt all sealed secrets in environment (ENV)
    label: kubeseal:re-encrypt {{.ENV}}
    requires:
      vars: [ENV]
    cmd: 'grep -Rl "^kind: SealedSecret$" --exclude-dir "*charts*" apps/*/{{.ENV}} | xargs -I {} sh -c "kubeseal --context {{.KUBECTL_CTX}} --re-encrypt -o yaml -w {} < \"{}\""'

  init:
    desc: Initialize a new app (APP) definition from templates/app
    silent: true
    requires:
      vars: [APP]
    cmds:
    - cp -r templates/app apps/{{.APP}}
    - find apps/{{.APP}} -type f -exec sed -i "s/APP_NAME/{{.APP}}/g" {} \;

  up:
    desc: Bring up app (APP) with dependencies in environment (ENV)
    requires:
      vars: [APP, ENV]
    cmds:
    - task: '{{.ENV}}:up'
    - task: bootstrap
    - task: apps:{{.APP}}

  all-up:
    aliases: [default]
    desc: Bring up all apps in environment (ENV)
    vars:
      APPS: {sh: "find apps/* -maxdepth 1 -name {{.ENV}} -type d | xargs -n1 dirname | xargs -n1 basename"}
    deps:
    - for: {var: APPS}
      task: up
      vars:
        APP: '{{.APP}}'
