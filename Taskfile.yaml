# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

run: when_changed
output: group

env:
  # renovate: datasource=github-releases depName=siderolabs/talos
  TALOS_VERSION: v1.12.0
  # renovate: datasource=github-releases depName=kubernetes/kubernetes
  KUBERNETES_VERSION: v1.35.0

vars:
  ENV: test
  KUBECTL_CTX: admin@{{.ENV}}
  KUBECTL: kubectl --context {{.KUBECTL_CTX}}
  ARGOCD_NAMESPACE: argocd

includes:
  clusters:production: clusters/production
  clusters:test: clusters/test
  apps: apps
  tests: tests/tasks.yaml

tasks:
  kubeconform:
    desc: Validate schema of all manifests under manifests/
    cmd: |
      kubeconform -output pretty \
        -kubernetes-version {{.KUBERNETES_VERSION | trimPrefix "v"}} \
        -schema-location default \
        -schema-location 'schemas/{{`{{.Group}}`}}/{{`{{.ResourceKind}}`}}_{{`{{.ResourceAPIVersion}}`}}.json' \
        -skip EnvoyProxy,Backend,SecurityPolicy \
        manifests/
    sources:
    - manifests/**/*

  renovate:
    desc: Local run of Mend Renovate
    env:
      LOG_LEVEL: DEBUG
      GITHUB_COM_TOKEN: {sh: gh auth token}
    cmds:
    - renovate --platform=local

  hydrate:
    desc: Hydrate all apps and environments to /manifests
    vars:
      APPS:
        sh: find apps -maxdepth 1 -mindepth 1 -type d -printf '%P\n'
    deps:
    - for: {var: APPS, as: APP}
      task: apps:{{.APP}}:build
    cmd: git add --intent-to-add manifests

  crds:
    desc: Apply CRDs to environment (ENV)
    cmd: '{{.KUBECTL}} apply --server-side -f crds/{{.ENV}}'
    requires:
      vars: [ENV]
    status:
    - '{{.KUBECTL}} diff -f crds/{{.ENV}}'

  bootstrap:
    desc: Bootstrap environment (ENV) with CRDs, Cilium, and Argo CD
    label: bootstrap {{.ENV}}
    deps: [hydrate]
    status:
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=1s deployment/argocd-server'
    sources:
    - manifests/{{.ENV}}/cilium/*.yaml
    - manifests/{{.ENV}}/argocd/rbac.authorization.k8s.io_v1_*.yaml
    - manifests/{{.ENV}}/argocd/v1_*.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-applicationset-controller.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-notifications-controller.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-redis.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-repo-server.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_deployment_argocd-server.yaml
    - manifests/{{.ENV}}/argocd/apps_v1_statefulset_argocd-application-controller.yaml
    - manifests/{{.ENV}}/argocd/batch_v1_job_argocd-redis-secret-init.yaml
    - manifests/{{.ENV}}/argocd/rbac.authorization.k8s.io_v1_*.yaml
    cmds:
    - task: crds
    - '{{.KUBECTL}} apply --server-side -f manifests/{{.ENV}}/cilium/v1_namespace_cilium-secrets.yaml'
    - '{{.KUBECTL}} apply --server-side -f manifests/{{.ENV}}/argocd/v1_namespace_argocd.yaml'
    - for: sources
      cmd: '{{.KUBECTL}} apply --server-side --force-conflicts -f {{.ITEM}}'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-applicationset-controller'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-notifications-controller'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-redis'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-repo-server'
    - '{{.KUBECTL}} wait --namespace {{.ARGOCD_NAMESPACE}} --for=condition=available --timeout=5m deployment/argocd-server'
    - '{{.KUBECTL}} rollout status --namespace {{.ARGOCD_NAMESPACE}} --watch --timeout=5m statefulset/argocd-application-controller'

  kubeseal:validate:
    desc: Validate all sealed secrets in environment (ENV) can be decrypted with kubeseal
    label: kubeseal:validate {{.ENV}}
    requires:
      vars: [ENV]
    cmd: find manifests/{{.ENV}} -name '*bitnami.com_v1alpha1_sealedsecret*.yaml' | xargs -I {} sh -c 'kubeseal --context {{.KUBECTL_CTX}} --validate < "{}"'

  kubeseal:re-encrypt:
    desc: Re-encrypt all sealed secrets in environment (ENV)
    label: kubeseal:re-encrypt {{.ENV}}
    requires:
      vars: [ENV]
    cmd: 'grep -Rl "^kind: SealedSecret$" --exclude-dir "*charts*" apps/*/{{.ENV}} | xargs -I {} sh -c "kubeseal --context {{.KUBECTL_CTX}} --re-encrypt -o yaml -w {} < \"{}\""'

  init:
    desc: Initialize a new app (APP) definition from templates/(TOOL)
    silent: true
    requires:
      vars: [APP]
    vars:
      TOOL: '{{.TOOL | default "kustomize"}}'
    cmds:
    - cp -r templates/{{.TOOL}} apps/{{.APP}}
    - find apps/{{.APP}} -type f -exec sed -i "s/APP_NAME/{{.APP}}/g" {} \;
    - yq -i '.includes.{{.APP}} = "{{.APP}}/tasks.yaml"' apps/Taskfile.yaml

  up:
    aliases: [default]
    desc: Bring up all apps in environment (ENV)
    cmds:
    - task: clusters:{{.ENV}}:up
    - task: bootstrap
    - task: deploy-all

  deploy-all:
    internal: true
    vars:
      APPS:
        sh: find manifests/{{.ENV}} -maxdepth 1 -mindepth 1 -type d -printf '%P\n'
    deps:
    - for: {var: APPS, as: APP}
      task: apps:{{.APP}}
