resources:
- ../base

helmCharts:
- name: argo-cd
  repo: https://argoproj.github.io/argo-helm
  releaseName: argocd
  namespace: argocd
  version: 5.52.2
  additionalValuesFiles:
  - ../base/values.yaml
  - values.yaml

secretGenerator:
- name: argocd-sops-age
  namespace: argocd
  literals:
  - keys.txt=''
  options:
    disableNameSuffixHash: true

patches:
- patch: |-
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: local-repo
        hostPath:
          path: /tmp/local-repo
          type: Directory
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/-
      value:
        name: local-repo
        mountPath: /tmp/local-repo
        readOnly: true
  target:
    kind: Deployment
    name: argocd-repo-server
- patch: |-
    - op: replace
      path: /spec/generators/0/git/repoURL
      value: file:///tmp/local-repo
    - op: replace
      path: /spec/template/spec/source/repoURL
      value: file:///tmp/local-repo
  target:
    kind: ApplicationSet
- patch: |-
    - op: replace
      path: /spec/generators/0/git/directories/0/path
      value: system/*/dev
  target:
    kind: ApplicationSet
    name: system
- patch: |-
    - op: replace
      path: /spec/generators/0/git/directories/0/path
      value: apps/*/dev
  target:
    kind: ApplicationSet
    name: apps
