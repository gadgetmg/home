apiVersion: batch/v1
kind: CronJob
metadata:
  labels:
    app.kubernetes.io/component: cleanup
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
  name: kyverno-cleanup-admission-reports
  namespace: kyverno
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata: null
        spec:
          containers:
          - command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              COUNT=$(kubectl get admissionreports.kyverno.io -A | wc -l)
              if [ "$COUNT" -gt 10000 ]; then
                echo "too many reports found ($COUNT), cleaning up..."
                kubectl delete admissionreports.kyverno.io -A -l='!audit.kyverno.io/report.aggregate'
              else
                echo "($COUNT) reports found, no clean up needed"
              fi
            image: bitnami/kubectl:1.28.5
            imagePullPolicy: null
            name: cleanup
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              privileged: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              seccompProfile:
                type: RuntimeDefault
          restartPolicy: OnFailure
          serviceAccountName: kyverno-cleanup-jobs
  schedule: '*/10 * * * *'
  successfulJobsHistoryLimit: 1
