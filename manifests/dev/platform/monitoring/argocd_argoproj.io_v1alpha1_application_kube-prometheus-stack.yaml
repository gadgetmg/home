apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
spec:
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: kube-prometheus-stack
    helm:
      valuesObject:
        cleanPrometheusOperatorObjectNames: true
        fullnameOverride: k8s
        grafana:
          envFromSecret: grafana-oidc-secret
          fullnameOverride: grafana
          grafana.ini:
            auth.generic_oauth:
              allow_sign_up: true
              api_url: https://auth.10.5.0.14.nip.io/realms/home/protocol/openid-connect/userinfo
              auth_url: https://auth.10.5.0.14.nip.io/realms/home/protocol/openid-connect/auth
              auto_login: true
              client_id: grafana
              email_attribute_path: email
              enabled: true
              login_attribute_path: username
              name: seigra.net
              name_attribute_path: full_name
              role_attribute_path: contains(roles[*], 'admin') && 'Admin' || contains(roles[*],
                'editor') && 'Editor' || contains(roles[*], 'viewer') && 'Viewer'
              role_attribute_strict: true
              scopes: openid email profile offline_access roles
              tls_skip_verify_insecure: true
              token_url: https://auth.10.5.0.14.nip.io/realms/home/protocol/openid-connect/token
            server:
              domain: grafana.10.5.0.13.nip.io
              root_url: https://grafana.10.5.0.13.nip.io
        kube-state-metrics:
          fullnameOverride: kube-state-metrics
        prometheus-node-exporter:
          fullnameOverride: node-exporter
          prometheus:
            monitor:
              attachMetadata:
                node: true
              relabelings:
              - action: replace
                regex: (.+)
                replacement: ${1}
                sourceLabels:
                - __meta_kubernetes_endpoint_node_name
                targetLabel: node
        prometheusOperator:
          fullnameOverride: prometheus-operator
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: v67.10.0
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    managedNamespaceMetadata:
      labels:
        pod-security.kubernetes.io/enforce: privileged
    syncOptions:
    - ServerSideApply=true
    - CreateNamespace=true
    - ApplyOutOfSyncOnly=true
    - FailOnSharedResource=true
