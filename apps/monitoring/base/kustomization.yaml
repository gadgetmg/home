# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
- namespace.yaml
- keycloak
- gateway

components:
- ../../../shared/components/strip-helm-labels
- ../../../shared/components/crd-configurations

helmCharts:
- name: prometheus-operator-crds
  repo: https://prometheus-community.github.io/helm-charts
  releaseName: prometheus-operator-crds
  version: 25.0.1
  includeCRDs: true
- name: kube-prometheus-stack
  repo: https://prometheus-community.github.io/helm-charts
  releaseName: kube-prometheus-stack
  namespace: monitoring
  skipTests: true
  version: 81.0.0
  apiVersions:
  - discovery.k8s.io/v1/EndpointSlice
  valuesInline:
    fullnameOverride: k8s
    grafana:
      fullnameOverride: grafana
      adminPassword: prom-operator
      grafana.ini:
        auth.generic_oauth:
          enabled: true
          auto_login: true
          name: seigra.net
          allow_sign_up: true
          client_id: grafana
          scopes: openid email profile offline_access
          email_attribute_path: email
          login_attribute_path: username
          name_attribute_path: full_name
          auth_url: https://auth.seigra.net/realms/home/protocol/openid-connect/auth
          token_url: https://auth.seigra.net/realms/home/protocol/openid-connect/token
          api_url: https://auth.seigra.net/realms/home/protocol/openid-connect/userinfo
          role_attribute_path: contains(groups[*], 'admin') && 'Admin' || contains(groups[*], 'editor') && 'Editor' || contains(groups[*], 'viewer') && 'Viewer'
          role_attribute_strict: true
          tls_skip_verify_insecure: true
        server:
          domain: grafana.seigra.net
          root_url: https://grafana.seigra.net
      envValueFrom:
        GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
          secretKeyRef:
            name: keycloak-client-grafana
            key: attribute.client_secret
    prometheusOperator:
      fullnameOverride: prometheus-operator
      prometheusConfigReloader:
        image:
          registry: quay.io
          repository: prometheus-operator/prometheus-config-reloader
          # renovate: datasource=docker depName=quay.io/prometheus-operator/prometheus-config-reloader
          tag: v0.88.0@sha256:501a47205f61acf8ad11b1caeb0bd117b135932728b17eb5cd5914a33f0ce704
      thanosImage:
        registry: quay.io
        repository: thanos/thanos
        # renovate: datasource=docker depName=quay.io/thanos/thanos
        tag: v0.40.1@sha256:aae7b2b030ed00d88abd8c5a357d08b46f22151ca0d50d9c796223fa332389c8
    cleanPrometheusOperatorObjectNames: true
    prometheus-node-exporter:
      namespaceOverride: kube-system
      fullnameOverride: node-exporter
      prometheus:
        monitor:
          attachMetadata:
            node: true
          relabelings:
          - sourceLabels:
            - __meta_kubernetes_endpoint_node_name
            targetLabel: node
            action: replace
            regex: (.+)
            replacement: ${1}
    kube-state-metrics:
      fullnameOverride: kube-state-metrics
- name: prometheus-adapter
  repo: https://prometheus-community.github.io/helm-charts
  releaseName: prometheus-adapter
  namespace: monitoring
  version: 5.2.0
  apiVersions:
  - apiregistration.k8s.io/v1
  valuesInline:
    prometheus:
      url: http://k8s-prometheus.monitoring.svc
    rules:
      default: false
      resource:
        cpu:
          containerQuery: |
            sum by (<<.GroupBy>>) (
              rate(container_cpu_usage_seconds_total{container!="",<<.LabelMatchers>>}[3m])
            )
          nodeQuery: |
            sum  by (<<.GroupBy>>) (
              rate(node_cpu_seconds_total{mode!="idle",mode!="iowait",mode!="steal",<<.LabelMatchers>>}[3m])
            )
          resources:
            overrides:
              node:
                resource: node
              namespace:
                resource: namespace
              pod:
                resource: pod
          containerLabel: container
        memory:
          containerQuery: |
            sum by (<<.GroupBy>>) (
              avg_over_time(container_memory_working_set_bytes{container!="",<<.LabelMatchers>>}[3m])
            )
          nodeQuery: |
            sum by (<<.GroupBy>>) (
              avg_over_time(node_memory_MemTotal_bytes{<<.LabelMatchers>>}[3m])
              -
              avg_over_time(node_memory_MemAvailable_bytes{<<.LabelMatchers>>}[3m])
            )
          resources:
            overrides:
              node:
                resource: node
              namespace:
                resource: namespace
              pod:
                resource: pod
          containerLabel: container
        window: 3m

images:
- name: quay.io/prometheus/node-exporter
  newTag: v1.10.2@sha256:337ff1d356b68d39cef853e8c6345de11ce7556bb34cda8bd205bcf2ed30b565
- name: docker.io/grafana/grafana
  newTag: 12.3.1@sha256:2175aaa91c96733d86d31cf270d5310b278654b03f5718c59de12a865380a31f
- name: quay.io/kiwigrid/k8s-sidecar
  newTag: 2.3.0@sha256:e57a47722113abcda1e5a1bf8a29807aa19ffa0ba7dfb295a758c929e1acb7e4
- name: quay.io/prometheus/alertmanager
  newTag: v0.30.1@sha256:286ad8838533a5a01d89bd09643f43d2b68b65203123b5700e54a8f80ff9c1f4
- name: quay.io/prometheus-operator/prometheus-operator
  newTag: v0.88.0@sha256:b4f51de53357a241fdcab2d956888c1cb3acb3c1f2f72ea0cd60046333ff06b0
- name: quay.io/prometheus/prometheus
  newTag: v3.9.1@sha256:1f0f50f06acaceb0f5670d2c8a658a599affe7b0d8e78b898c1035653849a702
- name: registry.k8s.io/kube-state-metrics/kube-state-metrics
  newTag: v2.17.0@sha256:2bbc915567334b13632bf62c0a97084aff72a36e13c4dabd5f2f11c898c5bacd
- name: registry.k8s.io/prometheus-adapter/prometheus-adapter
  newTag: v0.12.0@sha256:932eae60e2bcf9c4660d6442da066ef1a79b4ea7cc232c61c7303069216ca006
