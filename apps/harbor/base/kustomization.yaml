# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: harbor

resources:
- namespace.yaml
- gateway.yaml
- httproute.yaml
- core
- database
- jobservice
- portal
- redis
- registry
- trivy
- keycloak

components:
- ../../../shared/components/crd-configurations

configMapGenerator:
- name: harbor-common
  literals:
  - CORE_URL=http://harbor-core:80
  - LOG_LEVEL=info
  - REGISTRY_CONTROLLER_URL=http://harbor-registry:8080
  - REGISTRY_CREDENTIAL_USERNAME=harbor_registry_user
  - REGISTRY_URL=http://harbor-registry:5000
  - TOKEN_SERVICE_URL=http://harbor-core:80/service/token
- name: harbor-config-override-template
  options:
    disableNameSuffixHash: true
  literals:
  - auth_mode=oidc_auth
  - primary_auth_mode=true
  - project_creation_restriction=adminonly
  - read_only=false
  - token_expiration=30
  - oidc_name=seigra.net
  - oidc_endpoint=https://auth.seigra.net/realms/home
  - oidc_extra_redirect_parms={}
  - oidc_client_id=harbor
  - oidc_groups_claim=groups
  - oidc_admin_group=admin
  - oidc_scope=openid
  - oidc_verify_cert=true
  - oidc_auto_onboard=true
  - oidc_user_claim=email
  - robot_token_duration=30
  - robot_name_prefix=robot$
  - audit_log_forward_endpoint=""
  - skip_audit_log_database=false
  - scanner_skip_update_pulltime=true
  - banner_message=""

labels:
- pairs:
    app.kubernetes.io/instance: harbor
    app.kubernetes.io/part-of: harbor
  includeSelectors: true
  includeTemplates: true

replicas:
- name: harbor-core
  count: 2
- name: harbor-jobservice
  count: 2
- name: harbor-portal
  count: 2
- name: harbor-registry
  count: 2
- name: harbor-trivy
  count: 2

images:
- name: ghcr.io/cloudnative-pg/postgresql
  newTag: 18.1-minimal-trixie@sha256:f88715a4dc82c50aa1b4449f4ea0e51fa0a7e2a85d3118ffc1e0708a05f9bc69
- name: ghcr.io/goharbor/harbor-core
  newTag: v2.14.1@sha256:9c16d47ff207e7c83ba4b411eb02f6d919948118d8824b0d359711edeca55823
- name: ghcr.io/goharbor/harbor-jobservice
  newTag: v2.14.2@sha256:62584790a748273a299d436650955a37d90aa060bdf2ed08fa541e2272d1aa23
- name: ghcr.io/goharbor/harbor-portal
  newTag: v2.14.1@sha256:deebd48edd53f349a568da577949997d7c6b01749a493ad61d8beeeb148d6dd2
- name: ghcr.io/goharbor/harbor-registryctl
  newTag: v2.14.1@sha256:b9645ccc017dd694a3c8f34c39556e74e7cfe371e3abd9f1a7bc0f32401e354f
- name: ghcr.io/goharbor/registry-photon
  newTag: v2.14.1@sha256:986c9ad18ff754269fac3c388cb5dacc2e886b816439c8e8bf11cd92e76b6cdb
- name: ghcr.io/goharbor/trivy-adapter-photon
  newTag: v2.14.1@sha256:13dddb2adef7e28530e04e5659c49f550e5463e5f2536378ffd9207f7b23aac4
- name: docker.io/oliver006/redis_exporter
  newTag: v1.80.1-alpine@sha256:9c6a2f80054875ab36ca7020edbe68a1d05dd6745d030cc6317812ad14333897
- name: ghcr.io/valkey-io/valkey
  newTag: 9.0.0-alpine3.22@sha256:bef37d06d4856710973ee31dd1eac1482e4c8e6e7b847f999ad25433e646587b
