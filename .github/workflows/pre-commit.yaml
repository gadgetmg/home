name: pre-commit
run-name: pre-commit
on:
  push:
    branches:
    - main
  pull_request:
  repository_dispatch:
    types:
    - pre-commit

jobs:
  main:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@25aff27c252e0c8cdda3264805f7b6bcd92c8718 # v29
    - name: Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@6221693898146dc97e38ad0e013488a16477a4c4 # v9
      with:
        use-flakehub: false
    - name: Load Nix environment
      uses: nicknovitski/nix-develop@9be7cfb4b10451d3390a75dc18ad0465bed4932a # v1.2.1
      with:
        arguments: .#ci

    - name: Cache Task checksums
      uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      with:
        path: ./.task/
        key: .task-${{ github.ref_name }}-${{ hashFiles('**/*') }}
        restore-keys: |
          .task-${{ github.ref_name }}-
          .task-

    - name: Run pre-commit checks
      run: pre-commit run --all-files
      env:
        SKIP: no-commit-to-branch

    - name: Commit pre-commit automatic fixes
      id: pre-commit-fixes
      uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
      if: failure() && github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: .
        commit-message: '[pre-commit] automatic fixes'

    - name: Trigger workflow on new commit
      uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
      if: failure() && github.event_name == 'pull_request' && steps.pre-commit-fixes.outcome == 'success'
      with:
        event-type: pre-commit
