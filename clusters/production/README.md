# Talos configuration

The production cluster's configuration is generated with
[`talhelper genconfig`](https://github.com/budimanjojo/talhelper) based on the
`talconfig.yaml` and `talsecret.sops.yaml` files. `talosctl` is used to apply
configuration, upgrade Talos Linux, and upgrade the Kubernetes version on the
cluster based on the configuration generated by `talhelper`.

> ðŸ’¡ Note: When booted from the installation media, the nodes will run in
> "maintenance" mode. Applying a configuration to them with `talosctl` will
> install Talos to the disk and attempt to join the cluster.

The
[first node of the `etcd` cluster must be bootstrapped](https://www.talos.dev/v1.6/learn-more/control-plane/#cluster-bootstrapping)
manually with `talosctl`. Other nodes will then automatically join the cluster
based on their applied configuration.

## Disk encryption and UEFI Secure Boot

Working Secure Boot is required to enable
[secure TPM-backed disk encryption](https://www.talos.dev/v1.6/talos-guides/configuration/disk-encryption/).

### Node preparation

The nodes must be prepared to accept the Secure Boot keys provided by the Talos
installer. The UEFI firmware must be configured to clear all existing Secure
Boot keys to allow the Talos installer to apply Sidero's platform key to the
system.

> ðŸ’¡ Note: It is important to retain the Microsoft UEFI CA certificate in the
> signature database to continue to allow option ROMs (such as for display
> adapters) to load. **On HP systems specifically, failing to do so will prevent
> normal access to the UEFI firmware interface.**

Talos also requires TPM 2.0 to support TPM-backed disk encryption. While the HP
ProDesk 600 G3 ships with TPM 1.2,
[HP provides a firmware update](https://support.hp.com/us-en/document/c05381064)
to convert to TPM 2.0.

### Talos installer

The Secure Boot installation image must be obtained from the Talos
[Image Factory](https://factory.talos.dev/).

On first boot of the installer,
[use the `Enroll Secure Boot keys: auto` option in the boot options](https://www.talos.dev/v1.6/talos-guides/install/bare-metal-platforms/secureboot/#booting-talos-linux-in-secureboot-mode).
Once applied, the node will verify it is running in Secure Boot mode from the
dashboard as well as with the `talosctl get securitystate` command.

## Image Factory schematic

The Talos Image Factory generates and signs images with a configurable set of
extensions and kernel parameters. The following customization generates the
schematic ID of
`a13c1e1cdb9e135b5ae8ca3e977a5bee91bb4a503493d9204b6433239f462799` used in the
cluster:

```
customization:
  systemExtensions:
    officialExtensions:
    - siderolabs/drbd
    - siderolabs/i915-ucode
    - siderolabs/intel-ucode
```

## Network configuration

The nodes are configured for DHCP and configured with reservations from the
upstream server. The nodes are configured to
[share a virtual IP](https://www.talos.dev/v1.6/talos-guides/network/vip/) which
is used to ensure highly available access to the Kubernetes API.

## CNI configuration

By default, Talos installs Flannel as the cluster's CNI. This repository depends
on Cilium. Cilium cannot be installed directly by the Talos installer. Instead,
the cluster is
[created with no CNI and then manually bootstrapped with Cilium](https://www.talos.dev/v1.6/kubernetes-guides/network/deploying-cilium/).

## Control plane scheduling

For high-availability of the Kubernetes API, but also to limit the required
number of nodes, `talconfig.yaml` configures all three nodes as control plane
nodes, but allows scheduling workloads on them.

> ðŸ’¡ Note: While this is not strictly best practice, the alternative is losing
> high availability or purchasing additional worker nodes.

## Pod security

The default
[Pod Security Standards](https://www.talos.dev/latest/kubernetes-guides/configuration/pod-security)
profile is hardened to the `restricted` profile with a configuration patch in
`talconfig.yaml`. This is increased from the default `baseline` set by Talos.
